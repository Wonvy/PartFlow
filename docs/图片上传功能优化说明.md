# 图片上传功能优化说明

## 问题描述

在移动端，零件图片上传组件只能拍照，无法选择手机本地图片，用户体验不佳。

## 问题原因

原来的实现中，`<input type="file">` 元素设置了 `capture="environment"` 属性，这会强制要求使用相机，阻止用户选择本地图片。

```typescript
// 问题代码
<input
  type="file"
  accept="image/*"
  capture="environment"  // ❌ 强制使用相机
  onChange={handleFileSelect}
/>
```

## 解决方案

### 1. 分离拍照和选择功能

创建两个独立的 `<input>` 元素：
- **选择本地图片**：不带 `capture` 属性
- **拍照**：带 `capture="environment"` 属性

```typescript
// 选择本地图片的 input
<input
  ref={fileInputRef}
  type="file"
  accept="image/*"
  onChange={handleFileSelect}
  style={{ display: "none" }}
  aria-label="选择图片文件"
/>

// 拍照的 input
<input
  ref={cameraInputRef}
  type="file"
  accept="image/*"
  capture="environment"
  onChange={handleFileSelect}
  style={{ display: "none" }}
  aria-label="拍照"
/>
```

### 2. 优化用户界面

#### 空状态时的选择按钮

在图片上传区域添加两个明确的按钮：

```typescript
<div style={{ display: "flex", gap: 8, justifyContent: "center", marginBottom: 12 }}>
  <button onClick={() => fileInputRef.current?.click()}>
    📁 选择图片
  </button>
  <button onClick={() => cameraInputRef.current?.click()}>
    📷 拍照
  </button>
</div>
```

#### 已有图片时的操作按钮

当已有图片时，提供三个操作选项：

```typescript
<button onClick={() => fileInputRef.current?.click()}>
  📁 选择图片
</button>
<button onClick={() => cameraInputRef.current?.click()}>
  📷 拍照
</button>
<button onClick={handleRemove}>
  删除
</button>
```

### 3. 保持拖拽功能

拖拽功能仍然支持，用户可以直接拖拽图片到上传区域。

## 功能对比

### 优化前

❌ **问题**：
- 只能拍照，无法选择本地图片
- 用户体验受限
- 无法使用已有的图片文件

### 优化后

✅ **改善**：
- ✅ **选择本地图片**：从相册、文件管理器选择
- ✅ **拍照功能**：直接调用相机拍照
- ✅ **拖拽上传**：支持拖拽图片文件
- ✅ **剪贴板粘贴**：支持粘贴图片
- ✅ **清晰的操作选项**：用户明确知道每个按钮的作用

## 使用场景

### 移动端使用

1. **选择本地图片**：
   - 点击 "📁 选择图片" 按钮
   - 从相册选择已有图片
   - 从文件管理器选择图片文件

2. **拍照**：
   - 点击 "📷 拍照" 按钮
   - 直接调用相机应用
   - 拍摄新图片

3. **拖拽上传**：
   - 直接拖拽图片到上传区域
   - 支持桌面端和移动端

### 桌面端使用

1. **选择文件**：
   - 点击 "📁 选择图片" 按钮
   - 从文件系统选择图片

2. **拖拽上传**：
   - 拖拽图片文件到上传区域
   - 支持多文件拖拽（取第一个）

3. **剪贴板粘贴**：
   - 复制图片后按 Ctrl+V 粘贴

## 技术实现

### 状态管理

```typescript
const [preview, setPreview] = useState<string | null>(value || null);
const [isDragging, setIsDragging] = useState(false);
const [isProcessing, setIsProcessing] = useState(false);
const [showCamera, setShowCamera] = useState(false);
const fileInputRef = useRef<HTMLInputElement>(null);      // 选择本地图片
const cameraInputRef = useRef<HTMLInputElement>(null);     // 拍照
const dropZoneRef = useRef<HTMLDivElement>(null);
```

### 文件处理

```typescript
const handleFile = async (file: File) => {
  // 文件类型检查
  if (!file.type.startsWith("image/")) {
    alert("请选择图片文件！");
    return;
  }

  // 文件大小限制（5MB）
  if (file.size > 5 * 1024 * 1024) {
    alert("图片大小不能超过 5MB！");
    return;
  }

  // 转换为 base64
  const reader = new FileReader();
  reader.onload = (e) => {
    const result = e.target?.result as string;
    setPreview(result);
    onChange(result);
  };
  reader.readAsDataURL(file);
};
```

### 事件处理

```typescript
// 文件选择
const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
  const file = e.target.files?.[0];
  if (file) {
    handleFile(file);
  }
};

// 拖拽处理
const handleDrop = (e: React.DragEvent) => {
  e.preventDefault();
  setIsDragging(false);
  const file = e.dataTransfer.files?.[0];
  if (file) {
    handleFile(file);
  }
};

// 剪贴板粘贴
useEffect(() => {
  const handlePaste = (e: ClipboardEvent) => {
    const items = e.clipboardData?.items;
    if (!items) return;

    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      if (item.type.indexOf("image") !== -1) {
        e.preventDefault();
        const file = item.getAsFile();
        if (file) {
          handleFile(file);
        }
        break;
      }
    }
  };

  document.addEventListener("paste", handlePaste);
  return () => document.removeEventListener("paste", handlePaste);
}, []);
```

## 兼容性

### 浏览器支持

- ✅ **Chrome/Edge**：完全支持
- ✅ **Firefox**：完全支持
- ✅ **Safari**：完全支持
- ✅ **移动端浏览器**：完全支持

### 功能支持

| 功能 | 桌面端 | 移动端 | 说明 |
|------|--------|--------|------|
| 选择本地图片 | ✅ | ✅ | 文件选择器 |
| 拍照 | ❌ | ✅ | 相机应用 |
| 拖拽上传 | ✅ | ✅ | 触摸拖拽 |
| 剪贴板粘贴 | ✅ | ✅ | 复制粘贴 |

## 用户体验

### 操作流程

1. **首次上传**：
   - 看到上传区域
   - 选择 "📁 选择图片" 或 "📷 拍照"
   - 完成上传

2. **更换图片**：
   - 点击 "📁 选择图片" 选择新图片
   - 点击 "📷 拍照" 拍摄新图片
   - 点击 "删除" 移除图片

3. **批量操作**：
   - 支持拖拽多个文件（取第一个）
   - 支持剪贴板批量粘贴

### 视觉反馈

- **拖拽状态**：边框颜色变化
- **处理状态**：显示 "处理中..."
- **错误状态**：显示错误提示
- **成功状态**：显示图片预览

## 总结

通过分离拍照和选择功能，图片上传组件现在提供了更灵活的使用方式：

- 🎯 **移动端**：可以选择本地图片或拍照
- 🎯 **桌面端**：可以选择文件或拖拽上传
- 🎯 **通用功能**：支持剪贴板粘贴
- 🎯 **用户体验**：清晰的操作选项和视觉反馈

这个优化显著提升了移动端用户的使用体验，让图片上传变得更加便捷和灵活。
