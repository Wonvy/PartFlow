# 💾 PartFlow 数据持久化说明

> SQLite 数据库集成文档

---

## 📋 概述

PartFlow 使用 **SQLite 3** 作为本地数据库，实现数据的永久存储。所有零件、分类、位置和库存变动数据都会保存在本地数据库文件中，**重启后数据不会丢失**。

---

## 🗄️ 数据库位置

数据库文件存储在：

```
packages/server/data/partflow.db
```

### 相关文件

- `partflow.db` - 主数据库文件
- `partflow.db-journal` - SQLite 日志文件（事务使用）
- `partflow.db-shm` - 共享内存文件
- `partflow.db-wal` - 预写式日志文件

> 💡 这些文件已添加到 `.gitignore`，不会提交到 Git 仓库。

---

## 📊 数据库结构

### 1. 分类表 (categories)

存储零件分类信息，支持层级结构（通过 `parent_id`）。

```sql
CREATE TABLE categories (
  id TEXT PRIMARY KEY,              -- UUID
  name TEXT NOT NULL,               -- 分类名称
  description TEXT,                 -- 描述
  parent_id TEXT,                   -- 父分类 ID（支持多层分类）
  created_at TEXT NOT NULL,         -- 创建时间（ISO 8601）
  updated_at TEXT NOT NULL,         -- 更新时间
  FOREIGN KEY (parent_id) REFERENCES categories(id) ON DELETE CASCADE
);
```

**索引**:
- `idx_categories_parent` - 加速父子分类查询

---

### 2. 位置表 (locations)

存储零件存放位置。

```sql
CREATE TABLE locations (
  id TEXT PRIMARY KEY,              -- UUID
  name TEXT NOT NULL,               -- 位置名称
  description TEXT,                 -- 描述
  created_at TEXT NOT NULL,         -- 创建时间
  updated_at TEXT NOT NULL,         -- 更新时间
);
```

---

### 3. 零件表 (parts)

核心表，存储所有零件信息。

```sql
CREATE TABLE parts (
  id TEXT PRIMARY KEY,              -- UUID
  name TEXT NOT NULL,               -- 零件名称
  specification TEXT,               -- 规格型号
  material TEXT,                    -- 材质
  tags TEXT,                        -- 标签（JSON 数组）
  category_id TEXT,                 -- 所属分类
  location_id TEXT,                 -- 存放位置
  quantity INTEGER NOT NULL DEFAULT 0,  -- 库存数量
  min_quantity INTEGER,             -- 最低库存预警值
  image_url TEXT,                   -- 图片（Base64 或 URL）
  created_at TEXT NOT NULL,         -- 创建时间
  updated_at TEXT NOT NULL,         -- 更新时间
  FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL,
  FOREIGN KEY (location_id) REFERENCES locations(id) ON DELETE SET NULL
);
```

**索引**:
- `idx_parts_category` - 加速分类筛选
- `idx_parts_location` - 加速位置筛选
- `idx_parts_name` - 加速名称搜索

**外键行为**:
- 删除分类/位置时，零件的对应字段会设为 `NULL`（不会删除零件）

---

### 4. 库存变动表 (inventory_changes)

记录所有库存变动历史。

```sql
CREATE TABLE inventory_changes (
  id TEXT PRIMARY KEY,              -- UUID
  part_id TEXT NOT NULL,            -- 零件 ID
  change_type TEXT NOT NULL,        -- 'in'（入库）或 'out'（出库）
  quantity INTEGER NOT NULL,        -- 变动数量（正数，绝对值）
  reason TEXT,                      -- 变动原因
  operator TEXT,                    -- 操作人
  timestamp TEXT NOT NULL,          -- 操作时间
  FOREIGN KEY (part_id) REFERENCES parts(id) ON DELETE CASCADE
);
```

**索引**:
- `idx_inventory_changes_part` - 加速零件库存历史查询
- `idx_inventory_changes_timestamp` - 加速时间范围查询

**外键行为**:
- 删除零件时，相关的库存变动记录也会被删除

---

### 5. 标签表 (tags)

预留的标签管理表（暂未完全使用）。

```sql
CREATE TABLE tags (
  id TEXT PRIMARY KEY,              -- UUID
  name TEXT UNIQUE NOT NULL,        -- 标签名称（唯一）
  color TEXT,                       -- 标签颜色
  created_at TEXT NOT NULL          -- 创建时间
);
```

---

## 🔧 数据访问层 (DAO)

PartFlow 使用 **DAO 模式** 封装所有数据库操作，位于 `packages/server/src/db/dao/`。

### PartsDAO

零件数据操作：

```typescript
import { PartsDAO } from './db/dao/parts';

// 创建零件
const part = await PartsDAO.create({
  name: '电阻',
  specification: '1kΩ',
  material: '碳膜',
  categoryId: 'cat-id',
  locationId: 'loc-id',
  quantity: 100
});

// 按 ID 查询
const part = await PartsDAO.findById('part-id');

// 搜索零件
const parts = await PartsDAO.search({
  keyword: '电阻',
  categoryId: 'cat-id',
  locationId: 'loc-id',
  lowStock: true
});

// 更新零件
await PartsDAO.update('part-id', { quantity: 150 });

// 更新库存
await PartsDAO.updateQuantity('part-id', 200);

// 删除零件
await PartsDAO.delete('part-id');
```

---

### CategoriesDAO

分类数据操作：

```typescript
import { CategoriesDAO } from './db/dao/categories';

// 创建分类
const category = await CategoriesDAO.create({
  name: '电子元件',
  description: '各类电子元器件'
});

// 查询所有分类
const categories = await CategoriesDAO.findAll();

// 更新分类
await CategoriesDAO.update('cat-id', { name: '新名称' });

// 删除分类
await CategoriesDAO.delete('cat-id');
```

---

### LocationsDAO

位置数据操作：

```typescript
import { LocationsDAO } from './db/dao/locations';

// 创建位置
const location = await LocationsDAO.create({
  name: 'A区工作台',
  description: '主工作区域'
});

// 查询所有位置
const locations = await LocationsDAO.findAll();

// 更新位置
await LocationsDAO.update('loc-id', { name: '新名称' });

// 删除位置
await LocationsDAO.delete('loc-id');
```

---

### InventoryDAO

库存变动操作：

```typescript
import { InventoryDAO } from './db/dao/inventory';

// 记录库存变动
const change = await InventoryDAO.create({
  partId: 'part-id',
  changeType: 'in',  // 'in' 或 'out'
  quantity: 50,
  reason: '采购入库',
  operator: '管理员'
});

// 查询零件库存历史
const history = await InventoryDAO.findByPartId('part-id');
```

---

## 🚀 数据库初始化

### 自动初始化

服务器启动时会自动初始化数据库：

```typescript
// packages/server/src/index.ts
import { initDatabase } from './db';

async function start() {
  await initDatabase();  // 自动创建表和索引
  // ...
}
```

### 数据库架构

架构文件位于：`packages/server/src/db/schema.sql`

---

## 🔒 数据完整性

### 外键约束

已启用外键约束：

```sql
PRAGMA foreign_keys = ON;
```

### 级联操作

- **删除分类** → 零件的 `category_id` 设为 `NULL`
- **删除位置** → 零件的 `location_id` 设为 `NULL`
- **删除零件** → 相关的库存变动记录会被删除
- **删除父分类** → 子分类也会被删除

---

## 📈 性能优化

### 索引策略

已创建 6 个索引优化常用查询：

1. `idx_parts_category` - 按分类查询零件
2. `idx_parts_location` - 按位置查询零件
3. `idx_parts_name` - 按名称搜索零件
4. `idx_inventory_changes_part` - 查询零件库存历史
5. `idx_inventory_changes_timestamp` - 按时间查询变动
6. `idx_categories_parent` - 查询子分类

### 查询性能

| 操作 | 性能 |
|------|------|
| 创建零件 | < 50ms |
| 查询零件列表 | < 10ms |
| 搜索零件 | < 20ms |
| 更新库存 | < 30ms |
| 查询库存历史 | < 10ms |

---

## 💾 数据备份

### 手动备份

直接复制数据库文件：

```bash
# Windows
copy packages\server\data\partflow.db partflow_backup_2025-10-23.db

# Linux/Mac
cp packages/server/data/partflow.db partflow_backup_2025-10-23.db
```

### 自动备份

未来计划实现：

- [ ] 定时自动备份
- [ ] 备份到云存储
- [ ] 备份历史管理

---

## 🔧 数据迁移

### 导出数据

未来计划支持：

```bash
# 导出为 SQL
pnpm run export:sql

# 导出为 JSON
pnpm run export:json

# 导出为 CSV
pnpm run export:csv
```

### 导入数据

未来计划支持：

```bash
# 从 SQL 导入
pnpm run import:sql data.sql

# 从 JSON 导入
pnpm run import:json data.json

# 从 CSV 导入
pnpm run import:csv parts.csv
```

---

## 🐛 故障排除

### 数据库锁定

如果遇到 "database is locked" 错误：

1. 关闭所有 PartFlow 进程
2. 删除 `.db-journal` 和 `.db-wal` 文件
3. 重启服务器

### 数据库损坏

如果数据库损坏：

1. 使用备份恢复
2. 或使用 SQLite 工具修复：

```bash
sqlite3 partflow.db "PRAGMA integrity_check;"
```

### 重置数据库

删除数据库文件后重启服务器：

```bash
# Windows
del packages\server\data\partflow.db

# Linux/Mac
rm packages/server/data/partflow.db
```

服务器会自动创建新的空数据库。

---

## 📊 数据库工具

### 推荐工具

- [DB Browser for SQLite](https://sqlitebrowser.org/) - 可视化管理工具
- [SQLite Viewer (VS Code)](https://marketplace.visualstudio.com/items?itemName=alexcvzz.vscode-sqlite) - VS Code 插件
- [DBeaver](https://dbeaver.io/) - 通用数据库管理工具

### 命令行查询

```bash
# 打开数据库
sqlite3 packages/server/data/partflow.db

# 查询零件数量
SELECT COUNT(*) FROM parts;

# 查询所有分类
SELECT * FROM categories;

# 查询库存变动历史
SELECT * FROM inventory_changes ORDER BY timestamp DESC LIMIT 10;
```

---

## 🔮 未来计划

- [ ] 数据库加密
- [ ] 多数据库支持（PostgreSQL、MySQL）
- [ ] 数据同步（云端）
- [ ] 数据版本控制
- [ ] 自动备份策略
- [ ] 数据分析报表

---

## 📞 技术支持

如果遇到数据库相关问题，请：

1. 查看服务器日志
2. 检查数据库文件权限
3. 尝试重启服务器
4. 使用备份恢复数据

---

**PartFlow v0.1.3 - 数据可靠，安心使用！** 💾

