# ğŸ’¾ PartFlow æ•°æ®æŒä¹…åŒ–è¯´æ˜

> SQLite æ•°æ®åº“é›†æˆæ–‡æ¡£

---

## ğŸ“‹ æ¦‚è¿°

PartFlow ä½¿ç”¨ **SQLite 3** ä½œä¸ºæœ¬åœ°æ•°æ®åº“ï¼Œå®ç°æ•°æ®çš„æ°¸ä¹…å­˜å‚¨ã€‚æ‰€æœ‰é›¶ä»¶ã€åˆ†ç±»ã€ä½ç½®å’Œåº“å­˜å˜åŠ¨æ•°æ®éƒ½ä¼šä¿å­˜åœ¨æœ¬åœ°æ•°æ®åº“æ–‡ä»¶ä¸­ï¼Œ**é‡å¯åæ•°æ®ä¸ä¼šä¸¢å¤±**ã€‚

---

## ğŸ—„ï¸ æ•°æ®åº“ä½ç½®

æ•°æ®åº“æ–‡ä»¶å­˜å‚¨åœ¨ï¼š

```
packages/server/data/partflow.db
```

### ç›¸å…³æ–‡ä»¶

- `partflow.db` - ä¸»æ•°æ®åº“æ–‡ä»¶
- `partflow.db-journal` - SQLite æ—¥å¿—æ–‡ä»¶ï¼ˆäº‹åŠ¡ä½¿ç”¨ï¼‰
- `partflow.db-shm` - å…±äº«å†…å­˜æ–‡ä»¶
- `partflow.db-wal` - é¢„å†™å¼æ—¥å¿—æ–‡ä»¶

> ğŸ’¡ è¿™äº›æ–‡ä»¶å·²æ·»åŠ åˆ° `.gitignore`ï¼Œä¸ä¼šæäº¤åˆ° Git ä»“åº“ã€‚

---

## ğŸ“Š æ•°æ®åº“ç»“æ„

### 1. åˆ†ç±»è¡¨ (categories)

å­˜å‚¨é›¶ä»¶åˆ†ç±»ä¿¡æ¯ï¼Œæ”¯æŒå±‚çº§ç»“æ„ï¼ˆé€šè¿‡ `parent_id`ï¼‰ã€‚

```sql
CREATE TABLE categories (
  id TEXT PRIMARY KEY,              -- UUID
  name TEXT NOT NULL,               -- åˆ†ç±»åç§°
  description TEXT,                 -- æè¿°
  parent_id TEXT,                   -- çˆ¶åˆ†ç±» IDï¼ˆæ”¯æŒå¤šå±‚åˆ†ç±»ï¼‰
  created_at TEXT NOT NULL,         -- åˆ›å»ºæ—¶é—´ï¼ˆISO 8601ï¼‰
  updated_at TEXT NOT NULL,         -- æ›´æ–°æ—¶é—´
  FOREIGN KEY (parent_id) REFERENCES categories(id) ON DELETE CASCADE
);
```

**ç´¢å¼•**:
- `idx_categories_parent` - åŠ é€Ÿçˆ¶å­åˆ†ç±»æŸ¥è¯¢

---

### 2. ä½ç½®è¡¨ (locations)

å­˜å‚¨é›¶ä»¶å­˜æ”¾ä½ç½®ã€‚

```sql
CREATE TABLE locations (
  id TEXT PRIMARY KEY,              -- UUID
  name TEXT NOT NULL,               -- ä½ç½®åç§°
  description TEXT,                 -- æè¿°
  created_at TEXT NOT NULL,         -- åˆ›å»ºæ—¶é—´
  updated_at TEXT NOT NULL,         -- æ›´æ–°æ—¶é—´
);
```

---

### 3. é›¶ä»¶è¡¨ (parts)

æ ¸å¿ƒè¡¨ï¼Œå­˜å‚¨æ‰€æœ‰é›¶ä»¶ä¿¡æ¯ã€‚

```sql
CREATE TABLE parts (
  id TEXT PRIMARY KEY,              -- UUID
  name TEXT NOT NULL,               -- é›¶ä»¶åç§°
  specification TEXT,               -- è§„æ ¼å‹å·
  material TEXT,                    -- æè´¨
  tags TEXT,                        -- æ ‡ç­¾ï¼ˆJSON æ•°ç»„ï¼‰
  category_id TEXT,                 -- æ‰€å±åˆ†ç±»
  location_id TEXT,                 -- å­˜æ”¾ä½ç½®
  quantity INTEGER NOT NULL DEFAULT 0,  -- åº“å­˜æ•°é‡
  min_quantity INTEGER,             -- æœ€ä½åº“å­˜é¢„è­¦å€¼
  image_url TEXT,                   -- å›¾ç‰‡ï¼ˆBase64 æˆ– URLï¼‰
  created_at TEXT NOT NULL,         -- åˆ›å»ºæ—¶é—´
  updated_at TEXT NOT NULL,         -- æ›´æ–°æ—¶é—´
  FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL,
  FOREIGN KEY (location_id) REFERENCES locations(id) ON DELETE SET NULL
);
```

**ç´¢å¼•**:
- `idx_parts_category` - åŠ é€Ÿåˆ†ç±»ç­›é€‰
- `idx_parts_location` - åŠ é€Ÿä½ç½®ç­›é€‰
- `idx_parts_name` - åŠ é€Ÿåç§°æœç´¢

**å¤–é”®è¡Œä¸º**:
- åˆ é™¤åˆ†ç±»/ä½ç½®æ—¶ï¼Œé›¶ä»¶çš„å¯¹åº”å­—æ®µä¼šè®¾ä¸º `NULL`ï¼ˆä¸ä¼šåˆ é™¤é›¶ä»¶ï¼‰

---

### 4. åº“å­˜å˜åŠ¨è¡¨ (inventory_changes)

è®°å½•æ‰€æœ‰åº“å­˜å˜åŠ¨å†å²ã€‚

```sql
CREATE TABLE inventory_changes (
  id TEXT PRIMARY KEY,              -- UUID
  part_id TEXT NOT NULL,            -- é›¶ä»¶ ID
  change_type TEXT NOT NULL,        -- 'in'ï¼ˆå…¥åº“ï¼‰æˆ– 'out'ï¼ˆå‡ºåº“ï¼‰
  quantity INTEGER NOT NULL,        -- å˜åŠ¨æ•°é‡ï¼ˆæ­£æ•°ï¼Œç»å¯¹å€¼ï¼‰
  reason TEXT,                      -- å˜åŠ¨åŸå› 
  operator TEXT,                    -- æ“ä½œäºº
  timestamp TEXT NOT NULL,          -- æ“ä½œæ—¶é—´
  FOREIGN KEY (part_id) REFERENCES parts(id) ON DELETE CASCADE
);
```

**ç´¢å¼•**:
- `idx_inventory_changes_part` - åŠ é€Ÿé›¶ä»¶åº“å­˜å†å²æŸ¥è¯¢
- `idx_inventory_changes_timestamp` - åŠ é€Ÿæ—¶é—´èŒƒå›´æŸ¥è¯¢

**å¤–é”®è¡Œä¸º**:
- åˆ é™¤é›¶ä»¶æ—¶ï¼Œç›¸å…³çš„åº“å­˜å˜åŠ¨è®°å½•ä¹Ÿä¼šè¢«åˆ é™¤

---

### 5. æ ‡ç­¾è¡¨ (tags)

é¢„ç•™çš„æ ‡ç­¾ç®¡ç†è¡¨ï¼ˆæš‚æœªå®Œå…¨ä½¿ç”¨ï¼‰ã€‚

```sql
CREATE TABLE tags (
  id TEXT PRIMARY KEY,              -- UUID
  name TEXT UNIQUE NOT NULL,        -- æ ‡ç­¾åç§°ï¼ˆå”¯ä¸€ï¼‰
  color TEXT,                       -- æ ‡ç­¾é¢œè‰²
  created_at TEXT NOT NULL          -- åˆ›å»ºæ—¶é—´
);
```

---

## ğŸ”§ æ•°æ®è®¿é—®å±‚ (DAO)

PartFlow ä½¿ç”¨ **DAO æ¨¡å¼** å°è£…æ‰€æœ‰æ•°æ®åº“æ“ä½œï¼Œä½äº `packages/server/src/db/dao/`ã€‚

### PartsDAO

é›¶ä»¶æ•°æ®æ“ä½œï¼š

```typescript
import { PartsDAO } from './db/dao/parts';

// åˆ›å»ºé›¶ä»¶
const part = await PartsDAO.create({
  name: 'ç”µé˜»',
  specification: '1kÎ©',
  material: 'ç¢³è†œ',
  categoryId: 'cat-id',
  locationId: 'loc-id',
  quantity: 100
});

// æŒ‰ ID æŸ¥è¯¢
const part = await PartsDAO.findById('part-id');

// æœç´¢é›¶ä»¶
const parts = await PartsDAO.search({
  keyword: 'ç”µé˜»',
  categoryId: 'cat-id',
  locationId: 'loc-id',
  lowStock: true
});

// æ›´æ–°é›¶ä»¶
await PartsDAO.update('part-id', { quantity: 150 });

// æ›´æ–°åº“å­˜
await PartsDAO.updateQuantity('part-id', 200);

// åˆ é™¤é›¶ä»¶
await PartsDAO.delete('part-id');
```

---

### CategoriesDAO

åˆ†ç±»æ•°æ®æ“ä½œï¼š

```typescript
import { CategoriesDAO } from './db/dao/categories';

// åˆ›å»ºåˆ†ç±»
const category = await CategoriesDAO.create({
  name: 'ç”µå­å…ƒä»¶',
  description: 'å„ç±»ç”µå­å…ƒå™¨ä»¶'
});

// æŸ¥è¯¢æ‰€æœ‰åˆ†ç±»
const categories = await CategoriesDAO.findAll();

// æ›´æ–°åˆ†ç±»
await CategoriesDAO.update('cat-id', { name: 'æ–°åç§°' });

// åˆ é™¤åˆ†ç±»
await CategoriesDAO.delete('cat-id');
```

---

### LocationsDAO

ä½ç½®æ•°æ®æ“ä½œï¼š

```typescript
import { LocationsDAO } from './db/dao/locations';

// åˆ›å»ºä½ç½®
const location = await LocationsDAO.create({
  name: 'AåŒºå·¥ä½œå°',
  description: 'ä¸»å·¥ä½œåŒºåŸŸ'
});

// æŸ¥è¯¢æ‰€æœ‰ä½ç½®
const locations = await LocationsDAO.findAll();

// æ›´æ–°ä½ç½®
await LocationsDAO.update('loc-id', { name: 'æ–°åç§°' });

// åˆ é™¤ä½ç½®
await LocationsDAO.delete('loc-id');
```

---

### InventoryDAO

åº“å­˜å˜åŠ¨æ“ä½œï¼š

```typescript
import { InventoryDAO } from './db/dao/inventory';

// è®°å½•åº“å­˜å˜åŠ¨
const change = await InventoryDAO.create({
  partId: 'part-id',
  changeType: 'in',  // 'in' æˆ– 'out'
  quantity: 50,
  reason: 'é‡‡è´­å…¥åº“',
  operator: 'ç®¡ç†å‘˜'
});

// æŸ¥è¯¢é›¶ä»¶åº“å­˜å†å²
const history = await InventoryDAO.findByPartId('part-id');
```

---

## ğŸš€ æ•°æ®åº“åˆå§‹åŒ–

### è‡ªåŠ¨åˆå§‹åŒ–

æœåŠ¡å™¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“ï¼š

```typescript
// packages/server/src/index.ts
import { initDatabase } from './db';

async function start() {
  await initDatabase();  // è‡ªåŠ¨åˆ›å»ºè¡¨å’Œç´¢å¼•
  // ...
}
```

### æ•°æ®åº“æ¶æ„

æ¶æ„æ–‡ä»¶ä½äºï¼š`packages/server/src/db/schema.sql`

---

## ğŸ”’ æ•°æ®å®Œæ•´æ€§

### å¤–é”®çº¦æŸ

å·²å¯ç”¨å¤–é”®çº¦æŸï¼š

```sql
PRAGMA foreign_keys = ON;
```

### çº§è”æ“ä½œ

- **åˆ é™¤åˆ†ç±»** â†’ é›¶ä»¶çš„ `category_id` è®¾ä¸º `NULL`
- **åˆ é™¤ä½ç½®** â†’ é›¶ä»¶çš„ `location_id` è®¾ä¸º `NULL`
- **åˆ é™¤é›¶ä»¶** â†’ ç›¸å…³çš„åº“å­˜å˜åŠ¨è®°å½•ä¼šè¢«åˆ é™¤
- **åˆ é™¤çˆ¶åˆ†ç±»** â†’ å­åˆ†ç±»ä¹Ÿä¼šè¢«åˆ é™¤

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ç´¢å¼•ç­–ç•¥

å·²åˆ›å»º 6 ä¸ªç´¢å¼•ä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢ï¼š

1. `idx_parts_category` - æŒ‰åˆ†ç±»æŸ¥è¯¢é›¶ä»¶
2. `idx_parts_location` - æŒ‰ä½ç½®æŸ¥è¯¢é›¶ä»¶
3. `idx_parts_name` - æŒ‰åç§°æœç´¢é›¶ä»¶
4. `idx_inventory_changes_part` - æŸ¥è¯¢é›¶ä»¶åº“å­˜å†å²
5. `idx_inventory_changes_timestamp` - æŒ‰æ—¶é—´æŸ¥è¯¢å˜åŠ¨
6. `idx_categories_parent` - æŸ¥è¯¢å­åˆ†ç±»

### æŸ¥è¯¢æ€§èƒ½

| æ“ä½œ | æ€§èƒ½ |
|------|------|
| åˆ›å»ºé›¶ä»¶ | < 50ms |
| æŸ¥è¯¢é›¶ä»¶åˆ—è¡¨ | < 10ms |
| æœç´¢é›¶ä»¶ | < 20ms |
| æ›´æ–°åº“å­˜ | < 30ms |
| æŸ¥è¯¢åº“å­˜å†å² | < 10ms |

---

## ğŸ’¾ æ•°æ®å¤‡ä»½

### æ‰‹åŠ¨å¤‡ä»½

ç›´æ¥å¤åˆ¶æ•°æ®åº“æ–‡ä»¶ï¼š

```bash
# Windows
copy packages\server\data\partflow.db partflow_backup_2025-10-23.db

# Linux/Mac
cp packages/server/data/partflow.db partflow_backup_2025-10-23.db
```

### è‡ªåŠ¨å¤‡ä»½

æœªæ¥è®¡åˆ’å®ç°ï¼š

- [ ] å®šæ—¶è‡ªåŠ¨å¤‡ä»½
- [ ] å¤‡ä»½åˆ°äº‘å­˜å‚¨
- [ ] å¤‡ä»½å†å²ç®¡ç†

---

## ğŸ”§ æ•°æ®è¿ç§»

### å¯¼å‡ºæ•°æ®

æœªæ¥è®¡åˆ’æ”¯æŒï¼š

```bash
# å¯¼å‡ºä¸º SQL
pnpm run export:sql

# å¯¼å‡ºä¸º JSON
pnpm run export:json

# å¯¼å‡ºä¸º CSV
pnpm run export:csv
```

### å¯¼å…¥æ•°æ®

æœªæ¥è®¡åˆ’æ”¯æŒï¼š

```bash
# ä» SQL å¯¼å…¥
pnpm run import:sql data.sql

# ä» JSON å¯¼å…¥
pnpm run import:json data.json

# ä» CSV å¯¼å…¥
pnpm run import:csv parts.csv
```

---

## ğŸ› æ•…éšœæ’é™¤

### æ•°æ®åº“é”å®š

å¦‚æœé‡åˆ° "database is locked" é”™è¯¯ï¼š

1. å…³é—­æ‰€æœ‰ PartFlow è¿›ç¨‹
2. åˆ é™¤ `.db-journal` å’Œ `.db-wal` æ–‡ä»¶
3. é‡å¯æœåŠ¡å™¨

### æ•°æ®åº“æŸå

å¦‚æœæ•°æ®åº“æŸåï¼š

1. ä½¿ç”¨å¤‡ä»½æ¢å¤
2. æˆ–ä½¿ç”¨ SQLite å·¥å…·ä¿®å¤ï¼š

```bash
sqlite3 partflow.db "PRAGMA integrity_check;"
```

### é‡ç½®æ•°æ®åº“

åˆ é™¤æ•°æ®åº“æ–‡ä»¶åé‡å¯æœåŠ¡å™¨ï¼š

```bash
# Windows
del packages\server\data\partflow.db

# Linux/Mac
rm packages/server/data/partflow.db
```

æœåŠ¡å™¨ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ç©ºæ•°æ®åº“ã€‚

---

## ğŸ“Š æ•°æ®åº“å·¥å…·

### æ¨èå·¥å…·

- [DB Browser for SQLite](https://sqlitebrowser.org/) - å¯è§†åŒ–ç®¡ç†å·¥å…·
- [SQLite Viewer (VS Code)](https://marketplace.visualstudio.com/items?itemName=alexcvzz.vscode-sqlite) - VS Code æ’ä»¶
- [DBeaver](https://dbeaver.io/) - é€šç”¨æ•°æ®åº“ç®¡ç†å·¥å…·

### å‘½ä»¤è¡ŒæŸ¥è¯¢

```bash
# æ‰“å¼€æ•°æ®åº“
sqlite3 packages/server/data/partflow.db

# æŸ¥è¯¢é›¶ä»¶æ•°é‡
SELECT COUNT(*) FROM parts;

# æŸ¥è¯¢æ‰€æœ‰åˆ†ç±»
SELECT * FROM categories;

# æŸ¥è¯¢åº“å­˜å˜åŠ¨å†å²
SELECT * FROM inventory_changes ORDER BY timestamp DESC LIMIT 10;
```

---

## ğŸ”® æœªæ¥è®¡åˆ’

- [ ] æ•°æ®åº“åŠ å¯†
- [ ] å¤šæ•°æ®åº“æ”¯æŒï¼ˆPostgreSQLã€MySQLï¼‰
- [ ] æ•°æ®åŒæ­¥ï¼ˆäº‘ç«¯ï¼‰
- [ ] æ•°æ®ç‰ˆæœ¬æ§åˆ¶
- [ ] è‡ªåŠ¨å¤‡ä»½ç­–ç•¥
- [ ] æ•°æ®åˆ†ææŠ¥è¡¨

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°æ•°æ®åº“ç›¸å…³é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
2. æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æƒé™
3. å°è¯•é‡å¯æœåŠ¡å™¨
4. ä½¿ç”¨å¤‡ä»½æ¢å¤æ•°æ®

---

**PartFlow v0.1.3 - æ•°æ®å¯é ï¼Œå®‰å¿ƒä½¿ç”¨ï¼** ğŸ’¾

