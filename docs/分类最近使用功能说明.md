# 分类最近使用功能说明

## 功能概述

为分类选择下拉框添加最近使用功能，让用户能够快速选择常用的分类，提升操作效率。

## 问题解决

### 1. 新建零件页面空白问题

**问题原因**：用户删除了最近使用分类的相关代码，但 PartForm 组件缺少设计系统变量的导入，导致 TypeScript 错误阻止页面渲染。

**解决方案**：
```typescript
// 添加缺失的导入
import { colors, typography, spacing, borderRadius, transitions } from "../styles/design-system";
```

### 2. 最近使用分类功能

**功能特点**：
- 记录最近使用的 5 个分类
- 📱 本地存储，跨会话保持
- ⚡ 快速访问常用分类
- 🎯 智能排序（按使用时间）

## 技术实现

### 1. 工具函数 (`apps/web/src/utils/recentCategories.ts`)

#### 数据结构
```typescript
interface RecentCategory {
  id: string;
  name: string;
  icon?: string;
  lastUsed: number;  // 时间戳
}
```

#### 核心函数

**获取最近使用分类**：
```typescript
export function getRecentCategories(): RecentCategory[] {
  // 从 localStorage 读取并按时间排序
  const stored = localStorage.getItem('partflow_recent_categories');
  return JSON.parse(stored || '[]').sort((a, b) => b.lastUsed - a.lastUsed);
}
```

**添加分类到最近使用**：
```typescript
export function addRecentCategory(category: Category): void {
  const recent = getRecentCategories();
  const now = Date.now();
  
  // 检查是否已存在，更新或添加
  const existingIndex = recent.findIndex(item => item.id === category.id);
  if (existingIndex >= 0) {
    recent[existingIndex].lastUsed = now;  // 更新时间
  } else {
    recent.unshift({ id, name, icon, lastUsed: now });  // 添加新项
  }
  
  // 限制数量为 5 个
  const limitedRecent = recent
    .sort((a, b) => b.lastUsed - a.lastUsed)
    .slice(0, 5);
    
  localStorage.setItem('partflow_recent_categories', JSON.stringify(limitedRecent));
}
```

**构建选项列表**：
```typescript
export function buildCategoryOptionsWithRecent(
  allCategories: Category[], 
  recentCategories: RecentCategory[]
): Array<{ id: string; label: string; level: number }> {
  const result = [];
  
  // 添加最近使用部分
  if (recentCategories.length > 0) {
    result.push({ id: 'recent-header', label: '最近使用', level: 0 });
    
    recentCategories.forEach(recent => {
      const category = allCategories.find(cat => cat.id === recent.id);
      if (category) {
        result.push({
          id: category.id,
          label: `　${displayIcon}${category.name}`,
          level: 1
        });
      }
    });
    
    result.push({ id: 'separator', label: '────────────', level: 0 });
  }
  
  // 添加完整分类树
  buildTree(undefined, 0, '');
  return result;
}
```

### 2. 组件集成

#### PartForm 组件

**状态管理**：
```typescript
const [recentCategories, setRecentCategories] = useState(getRecentCategories());
```

**分类选择处理**：
```typescript
const handleCategoryChange = (categoryId: string) => {
  setFormData({ ...formData, categoryId });
  
  // 添加到最近使用
  if (categoryId) {
    const selectedCategory = categories.find(cat => cat.id === categoryId);
    if (selectedCategory) {
      addRecentCategory(selectedCategory);
      setRecentCategories(getRecentCategories());  // 更新状态
    }
  }
};
```

**下拉框渲染**：
```typescript
<select onChange={(e) => handleCategoryChange(e.target.value)}>
  <option value="">-- 请选择 --</option>
  {buildCategoryOptionsWithRecent(categories, recentCategories).map((cat) => (
    <option 
      key={cat.id} 
      value={cat.id}
      disabled={cat.id === "recent-header" || cat.id === "separator"}
      style={{
        paddingLeft: `${cat.level * 16}px`,
        fontWeight: cat.id === "recent-header" ? "bold" : "normal",
        color: cat.id === "separator" ? "#ccc" : "inherit",
        backgroundColor: cat.id === "recent-header" ? "#f0f0f0" : "inherit"
      }}
    >
      {cat.label}
    </option>
  ))}
</select>
```

#### PartsList 组件

同样的实现方式，用于零件列表页面的分类筛选。

## 用户界面

### 下拉框结构

```
-- 请选择 --
最近使用                       (标题，不可选)
　📱 手机配件                  (最近使用项)
　🔧 电子元件                  (最近使用项)
　⚡ 电源模块                  (最近使用项)
────────────                   (分隔线，不可选)
📱 手机配件                    (完整分类树)
　📱 屏幕组件
　　📱 触摸屏
　　📱 显示屏
　🔧 维修工具
🔧 电子元件
　⚡ 电源模块
　🔌 连接器
```

### 视觉设计

- **最近使用标题**：粗体文字 + 浅灰背景
- **最近使用项**：缩进显示，正常字体
- **分隔线**：灰色虚线，不可选择
- **完整分类**：层级缩进，支持图标显示

## 存储机制

### LocalStorage 结构

```json
{
  "partflow_recent_categories": [
    {
      "id": "cat-123",
      "name": "手机配件",
      "icon": "📱",
      "lastUsed": 1761322498596
    },
    {
      "id": "cat-456", 
      "name": "电子元件",
      "icon": "🔧",
      "lastUsed": 1761322400000
    }
  ]
}
```

### 数据管理

- **容量限制**：最多保存 5 个最近使用的分类
- **排序规则**：按 `lastUsed` 时间戳降序排列
- **去重机制**：相同分类更新时间而不重复添加
- **持久化**：使用 localStorage 跨会话保存

## 性能优化

### 1. 智能更新

- 只在分类选择时更新最近使用列表
- 使用 `useState` 避免不必要的重新渲染
- LocalStorage 操作异常处理

### 2. 内存管理

- 限制最近使用分类数量（5个）
- 及时清理过期数据
- 错误处理避免数据损坏

### 3. 用户体验

- 即时反馈：选择后立即更新列表
- 视觉区分：最近使用项有明显标识
- 操作便捷：最常用的分类排在最前面

## 兼容性

### 浏览器支持

- ✅ **Chrome/Edge**：完全支持
- ✅ **Firefox**：完全支持  
- ✅ **Safari**：完全支持
- ✅ **移动端浏览器**：完全支持

### 降级处理

```typescript
export function getRecentCategories(): RecentCategory[] {
  try {
    const stored = localStorage.getItem(RECENT_CATEGORIES_KEY);
    if (!stored) return [];
    return JSON.parse(stored);
  } catch (error) {
    console.error('获取最近使用分类失败:', error);
    return [];  // 降级返回空数组
  }
}
```

## 使用场景

### 1. 新建零件

用户创建新零件时：
1. 打开分类下拉框
2. 看到最近使用的分类在顶部
3. 快速选择常用分类
4. 分类自动添加到最近使用

### 2. 零件筛选

用户筛选零件时：
1. 使用分类筛选下拉框
2. 最近使用的分类优先显示
3. 提升筛选效率

### 3. 批量操作

用户批量创建相似零件时：
1. 第一次选择分类后加入最近使用
2. 后续创建直接从最近使用选择
3. 显著提升操作效率

## 数据流程

```
用户选择分类
    ↓
handleCategoryChange()
    ↓
addRecentCategory()
    ↓
更新 localStorage
    ↓
setRecentCategories()
    ↓
重新渲染下拉框
    ↓
最近使用项显示在顶部
```

## 总结

最近使用分类功能通过以下方式提升用户体验：

- 🚀 **效率提升**：常用分类快速访问
- 💾 **智能记忆**：自动记录使用习惯
- 🎯 **精准推荐**：基于使用频率排序
- 📱 **跨平台**：支持所有现代浏览器
- 🔄 **实时更新**：选择后立即生效

这个功能让分类选择变得更加高效，特别适合需要频繁创建相似零件的用户场景。
