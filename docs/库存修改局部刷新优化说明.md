# 库存修改局部刷新优化说明

## 问题描述

在之前的版本中，当用户修改零件库存时（通过 +/- 按钮或直接修改输入框），系统会重新加载整个零件列表，这会导致：

1. **操作体验差**：页面会重新渲染，用户可能会失去当前的浏览位置
2. **性能问题**：不必要的网络请求和数据重新渲染
3. **用户界面闪烁**：整个列表重新加载会造成视觉上的闪烁

## 解决方案

### 优化前的代码
```typescript
const handleInventoryChange = async (part: Part, delta: number) => {
  const reason = delta > 0 ? "入库" : "出库";
  try {
    await api.updateInventory(part.id, delta, reason);
    loadParts(); // 重新加载整个列表
  } catch (err) {
    alert(`库存更新失败: ${err instanceof Error ? err.message : "未知错误"}`);
  }
};
```

### 优化后的代码
```typescript
const handleInventoryChange = async (part: Part, delta: number) => {
  const reason = delta > 0 ? "入库" : "出库";
  try {
    const response = await api.updateInventory(part.id, delta, reason);
    
    // 局部更新：只更新当前零件的数据，避免整个列表刷新
    setParts(prevParts => 
      prevParts.map(p => 
        p.id === part.id 
          ? { ...p, quantity: response.data.quantity } // 使用服务器返回的最新数量
          : p
      )
    );
  } catch (err) {
    alert(`库存更新失败: ${err instanceof Error ? err.message : "未知错误"}`);
  }
};
```

## 技术实现

### 1. 服务器端支持
服务器端的 `/parts/:id/inventory` 接口已经返回更新后的零件数据：
```typescript
return { data: updatedPart };
```

### 2. 客户端 API 类型定义
API 客户端正确定义了返回类型：
```typescript
updateInventory: (id: string, delta: number, reason?: string) =>
  fetchAPI<{ data: Part }>(`/parts/${id}/inventory`, {
    method: "POST",
    body: JSON.stringify({ delta, reason })
  })
```

### 3. React 状态局部更新
使用 `setParts` 的函数式更新，只修改特定零件的数据：
```typescript
setParts(prevParts => 
  prevParts.map(p => 
    p.id === part.id 
      ? { ...p, quantity: response.data.quantity }
      : p
  )
);
```

## 优化效果

### 用户体验改善
- ✅ **无页面闪烁**：只更新特定零件卡片，其他内容保持不变
- ✅ **保持浏览位置**：用户不会失去当前的滚动位置
- ✅ **响应更快**：无需重新加载整个列表
- ✅ **操作连续性**：可以连续修改多个零件的库存

### 性能提升
- ✅ **减少网络请求**：不需要重新获取整个零件列表
- ✅ **减少渲染开销**：只重新渲染一个零件卡片
- ✅ **内存效率**：避免重复创建大量组件实例

## 适用场景

这个优化适用于以下两种库存修改方式：

1. **点击 +/- 按钮**：直接调用 `handleInventoryChange`
2. **修改输入框数值**：在 `onBlur` 事件中调用 `handleInventoryChange`

## 影响范围

- ✅ Web 端：`apps/web/src/components/PartsList.tsx`
- ✅ 桌面端：`apps/desktop/src/components/PartsList.tsx`
- ✅ 移动端：通过 Web 端访问时自动享受此优化

## 注意事项

1. **数据一致性**：使用服务器返回的最新数量，确保数据准确性
2. **错误处理**：如果更新失败，不会修改本地状态，保持数据一致性
3. **并发安全**：React 的函数式状态更新确保并发操作的安全性

## 版本信息

- **优化版本**：v0.5.1
- **影响文件**：
  - `apps/web/src/components/PartsList.tsx`
  - `apps/desktop/src/components/PartsList.tsx`
- **向后兼容**：完全兼容，无需额外配置
